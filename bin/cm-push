#!/bin/bash

usage() {
    echo "Usage:"
    echo "  cm-push [options] branch"
    echo
    echo "  Options:"
    echo "    -d  Upload change as draft."
    echo "    -f Force push."
    echo "    -m Bypass review and merge."
    echo "    -r <ref> Push to specified ref ( will override draft )."
    echo "    -t <topic> Append topic to change."
    echo
    echo "  Example:"
    echo "    cm-push -d -t test cm-13.0"
    echo
    exit 1
}

merge=0
while getopts ":dfmr:t:" opt; do
    case $opt in
        d) [ -z "$ref" ] && ref="ref/drafts/" ;;
        f) push_args="-f" ;;
        m) merge=1 ;;
        r) ref="ref/$OPTARG/" ;;
        t) topic="%topic=$OPTARG" ;;
        :)
          echo "Option -$OPTARG requires an argument"
          echo
          usage
          ;;
        \?)
          echo "Invalid option: -$OPTARG"
          echo
          usage
          ;;
    esac
done
shift $((OPTIND-1))

if [ "$#" -ne 1 ]; then
    usage
fi

if [ -z "$ref" ]; then
    ref="refs/for/"
fi

if [ "$merge" -eq 1 ]; then
    ref=""
fi

repo_name=$(git remote -v | grep CyanogenMod | head -n1 | awk '{print $2}' | sed 's/.*\///' | sed 's/\.git//')
username=$(git config review.review.cyanogenmod.org.username)

git push ${push_args} ssh://${username}@review.cyanogenmod.org:29418/CyanogenMod/${repo_name} HEAD:${ref}$1${topic}
